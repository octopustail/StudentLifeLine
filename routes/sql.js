/**
 * Created by evanswu on 2018/3/8.
 */
const DataProcesClain = require('../controllers/DataProcessChain.js');
const queryInDatabase = require('./../controllers/queryInDatabase');

let returnData = '';


const entropyDistributionDataProcess = function (req, res, next) {
    const queryProcessClain = new DataProcesClain(req.query);

    const sendToClientHandler = function () {
        res.send(returnData);
        res.end();
        return Promise.resolve();
    };

    // calKDE, kdeDataProcess
    queryProcessClain.addChain([getSQL, queryInDatabase, dataProcess])
        .sendToClient(sendToClientHandler);

};

/**
 * 只会传输认同的数据;
 * @param query
 */
const getSQL = function () {
    //只会传认可的白名单数据;
    let sql =`select student_id from gpa_rank where student_id like "29%" order by score_1s ASC limit 1,100;`;
    // top 100 student :
    // 2902111025,2905403025,2907306007,2907305007,2901312033,2905101033,2902108024,2905402035,2904301031,2905401015,2905102033,2923102030,2901307007,2901101011,2909101004,2902108028,2902105004,2903003004,2907306028,2902113020,2906305011,2907305025,2903005008,2901311010,2902106030,2923103017,2907104026,2902109029,2903005018,2902101024,2903103018,2906303007,2908003024,2901309036,2903001022,2902001002,2902111016,2908001022,2903004002,2904202016,2908008005,2903305016,2904202026,2905103026,2923103009,2902107030,2902108007,2902301023,2903004001,2907105025,2907303003,2905101020,2901311029,2902001005,2902110017,2906306008,2902113021,2902112026,2902110013,2904201005,2901201002,2902112011,2901312022,2908403003,2905301021,2903005009,2905404026,2902107008,2902109030,2902108023,2908004019,2908007035,2903102011,2903103002,2904102020,2903102008,2908402017,2901309020,2907304009,2907201027,2902109024,2901305004,2904202015,2905201012,2908002028,2903004018,2902104003,2901203033,2901301026,2905201023,2904302004,2906305031,2903203002,2902109016,2908401031,2901303021,2909101008,2907104004,2903101026,2902103025
    // bottom 100 student :
    // 2907304024,2909202022,2910102002,2903303006,2913103007,2923105015,2902112025,2923105019,2906005026,2923105018,2904101001,2901309005,2923102001,2908401015,2901203026,2906002031,2901201005,2912602004,2907305010,2910201021,2907102015,2904102012,2907101010,2923105007,2912601008,2907201015,2902113019,2908202013,2906004015,2903201030,2903402022,2907102024,2906001026,2906003032,2904101017,2906004031,2907102023,2923105002,2906007023,2902103023,2906304008,2903302025,2910101002,2905102016,2905201011,2907201018,2904102028,2903304017,2907102020,2905404021,2907301030,2901203023,2909201011,2906302013,2912602029,2909102013,2907301022,2905404009,2901201028,2901201010,2909201017,2907305024,2904102016,2923105006,2909103011,2923103026,2910101012,2911103027,2906301005,2903304022,2909202029,2905103003,2902302016,2905302001,2911101026,2907303016,2906003018,2907306024,2907305029,2911103030,2905403013,2912801014,2912602003,2905402027,2912601027,2903402020,2906007004,2906003012,2903002026,2910101003,2906003014,2904102015,2903402019,2903102024,2912702007,2903202023,2905404008,2911101025,2902302022,2908005020


    return Promise.resolve(sql);
};


/**
 * 需要把数据处理成需要的样子;
 * @returns {Promise.<T>}
 */
const dataProcess = function (data) {
    returnData = data.map(function(line){
        return line['student_id'];
    }).toString();


    return Promise.resolve(returnData);
};




module.exports = entropyDistributionDataProcess;